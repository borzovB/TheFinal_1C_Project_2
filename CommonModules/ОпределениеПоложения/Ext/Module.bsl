//Функция позволяет получать координаты местоположения локального устройства
&НаКлиенте
Функция ПолучитьТекущееМестоположение() Экспорт 
	ТекущееМестоположение = Неопределено;
	
	#Если МобильноеПриложениеКлиент Тогда
		Провайдер = СредстваГеопозиционирования.ПолучитьСамогоЭнергоЭкономичногоПровайдера();
		Если Провайдер = Неопределено Тогда
			ПоказатьПредупреждение(, "Нет доступных провайдеров геолокации!");
			Возврат ТекущееМестоположение;
		КонецЕсли;
		
		Попытка
			Если СредстваГеопозиционирования.ОбновитьМестоположение(Провайдер.Имя, 60) Тогда
				ДанныеМестоположения = СредстваГеопозиционирования.ПолучитьПоследнееМестоположение(Провайдер.Имя);
				Если ДанныеМестоположения <> Неопределено Тогда
					Координаты = ДанныеМестоположения.Координаты;
					Если Координаты.Широта >= -90 И Координаты.Широта <= 90 И Координаты.Долгота >= -180 И Координаты.Долгота <= 180 Тогда
						ТекущееМестоположение = Новый Структура("Широта, Долгота", Координаты.Широта, Координаты.Долгота);
					Иначе
						ПоказатьПредупреждение(, "Некорректные координаты!");
					КонецЕсли;
				Иначе
					ПоказатьПредупреждение(, "Данные местоположения не получены!");
				КонецЕсли;
			Иначе
				ПоказатьПредупреждение(, "Не удалось обновить местоположение!");
			КонецЕсли;
		Исключение
			ПоказатьПредупреждение(, "Ошибка геолокации: " + ОписаниеОшибки());
		КонецПопытки;
	#Иначе
		ПоказатьПредупреждение(, "Геолокация недоступна в этом клиенте!");
	#КонецЕсли
	
	Возврат ТекущееМестоположение;
КонецФункции

//Процедура отображает карту с текущим местоположением устройства
&НаКлиенте
Процедура ОткрытьКартуСМестоположением() Экспорт 
	ТекущееМестоположение = ПолучитьТекущееМестоположение();
	
	Если ТекущееМестоположение = Неопределено Тогда
		ПоказатьПредупреждение(, "Не удалось определить местоположение!");
		Возврат;
	КонецЕсли;
	
	// Формируем URL для Google Maps
	Широта = Формат(ТекущееМестоположение.Широта, "ЧРД=.; ЧГ=0");
	Долгота = Формат(ТекущееМестоположение.Долгота, "ЧРД=.; ЧГ=0");
	URLКарты = "https://www.google.com/maps?q=" + Широта + "," + Долгота;
		
	Попытка
		ЗапуститьПриложение(URLКарты);
	Исключение
		ПоказатьПредупреждение(, "Ошибка при открытии карты: " + ОписаниеОшибки());
	КонецПопытки;
КонецПроцедуры

// Формирование URL для маршрута
&НаКлиенте
Функция СоздатьURLМаршрутаДоТочки(ДанныеАдреса, ТекущееМестоположение = Неопределено) Экспорт 
	
	// Формируем конечную точку
	ЧастиАдреса = Новый Массив;
	Если ЗначениеЗаполнено(ДанныеАдреса.Индекс) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Индекс);
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеАдреса.Страна) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Страна);
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеАдреса.Регион) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Регион);
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеАдреса.Город) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Город);
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеАдреса.Улица) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Улица);
	КонецЕсли;
	Если ЗначениеЗаполнено(ДанныеАдреса.Дом) Тогда
		ЧастиАдреса.Добавить(ДанныеАдреса.Дом);
	КонецЕсли;
	КонечныйАдрес = СтрЗаменить(СтрСоединить(ЧастиАдреса, ","), " ", "+");
	
	// Формируем URL
	Если ТекущееМестоположение <> Неопределено Тогда
		Начало = Формат(ТекущееМестоположение.Широта, "ЧРД=.; ЧГ=0") + "," + Формат(ТекущееМестоположение.Долгота, "ЧРД=.; ЧГ=0");
		URL = "https://maps.google.com/maps?saddr=" + Начало + "&daddr=" + КонечныйАдрес;
	Иначе
		URL = "https://maps.google.com/maps?daddr=" + КонечныйАдрес;
	КонецЕсли;
	
	Возврат URL;
	
КонецФункции

// Функция создания URL маршрута
&НаКлиенте
Функция СоздатьURLМаршрутаМеждуТочками(ДанныеМаршрута)Экспорт 
	Результат = Новый Структура("URL, Начало", "", "");
	
	Если ДанныеМаршрута.Количество() < 2 Тогда
		ПоказатьПредупреждение(, НСтр("ru='Недостаточно точек для маршрута!'"));
		Возврат Результат;
	КонецЕсли;
	
	// Формируем начальную точку
	ПервыйАдрес = ДанныеМаршрута[0];
	ЧастиАдреса = Новый Массив;
	Если ЗначениеЗаполнено(ПервыйАдрес.Индекс) Тогда
		ЧастиАдреса.Добавить(ПервыйАдрес.Индекс);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПервыйАдрес.Город) Тогда
		ЧастиАдреса.Добавить(ПервыйАдрес.Город);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПервыйАдрес.Улица) Тогда
		ЧастиАдреса.Добавить(ПервыйАдрес.Улица);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПервыйАдрес.Дом) Тогда
		ЧастиАдреса.Добавить(ПервыйАдрес.Дом);
	КонецЕсли;
	Начало = СтрСоединить(ЧастиАдреса, ", ");
	Результат.Начало = Начало;
	Начало = СтрЗаменить(Начало, " ", "+");
	
	// Формируем конечную точку
	ПоследнийАдрес = ДанныеМаршрута[ДанныеМаршрута.Количество() - 1];
	ЧастиАдреса = Новый Массив;
	Если ЗначениеЗаполнено(ПоследнийАдрес.Индекс) Тогда
		ЧастиАдреса.Добавить(ПоследнийАдрес.Индекс);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПоследнийАдрес.Город) Тогда
		ЧастиАдреса.Добавить(ПоследнийАдрес.Город);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПоследнийАдрес.Улица) Тогда
		ЧастиАдреса.Добавить(ПоследнийАдрес.Улица);
	КонецЕсли;
	Если ЗначениеЗаполнено(ПоследнийАдрес.Дом) Тогда
		ЧастиАдреса.Добавить(ПоследнийАдрес.Дом);
	КонецЕсли;
	Конец = СтрСоединить(ЧастиАдреса, ", ");
	Конец = СтрЗаменить(Конец, " ", "+");
	
	// Формируем промежуточные точки
	ПромежуточныеТочки = "";
	Для Индекс = 1 По ДанныеМаршрута.Количество() - 2 Цикл
		Адрес = ДанныеМаршрута[Индекс];
		ЧастиАдреса = Новый Массив;
		Если ЗначениеЗаполнено(Адрес.Индекс) Тогда
			ЧастиАдреса.Добавить(Адрес.Индекс);
		КонецЕсли;
		Если ЗначениеЗаполнено(Адрес.Город) Тогда
			ЧастиАдреса.Добавить(Адрес.Город);
		КонецЕсли;
		Если ЗначениеЗаполнено(Адрес.Улица) Тогда
			ЧастиАдреса.Добавить(Адрес.Улица);
		КонецЕсли;
		Если ЗначениеЗаполнено(Адрес.Дом) Тогда
			ЧастиАдреса.Добавить(Адрес.Дом);
		КонецЕсли;
		Точка = СтрСоединить(ЧастиАдреса, ", ");
		Точка = СтрЗаменить(Точка, " ", "+");
		ПромежуточныеТочки = ПромежуточныеТочки + "/" + Точка;
	КонецЦикла;
	
	// Формируем URL
	URL = "https://www.google.com/maps/dir/" + Начало + "/" + Конец + ПромежуточныеТочки;
	Результат.URL = URL;
	
	Возврат Результат;
КонецФункции

//Функция необходима для создания запроса при отображении текущего местположения водителя и маршрута
&НаКлиенте
Функция СформироватьURLМаршрутаТочка(ДанныеМаршрута, ТекущееМестоположение) Экспорт 
    // Проверяем, есть ли данные для маршрута
    Если ДанныеМаршрута.Количество() = 0 Тогда
        Возврат "";
    КонецЕсли;
    
    // Проверяем корректность координат начальной точки
    Если ТекущееМестоположение = Неопределено
        Или ТекущееМестоположение.Широта < -90 Или ТекущееМестоположение.Широта > 90
        Или ТекущееМестоположение.Долгота < -180 Или ТекущееМестоположение.Долгота > 180 Тогда
        Возврат "";
    КонецЕсли;
    
    // Формируем начальную точку из координат
    Начало = СтрШаблон("%1,%2",
        Формат(ТекущееМестоположение.Широта, "ЧРД=.; ЧГ=0"),
        Формат(ТекущееМестоположение.Долгота, "ЧРД=.; ЧГ=0"));
    
    // Формируем конечную точку (первая точка из ДанныеМаршрута)
    ПервыйАдрес = ДанныеМаршрута[0];
    ЧастиАдреса = Новый Массив;
    Если ЗначениеЗаполнено(ПервыйАдрес.Индекс) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Индекс);
    КонецЕсли;
    Если ЗначениеЗаполнено(ПервыйАдрес.Страна) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Страна);
    КонецЕсли;
    Если ЗначениеЗаполнено(ПервыйАдрес.Регион) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Регион);
    КонецЕсли;
    Если ЗначениеЗаполнено(ПервыйАдрес.Город) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Город);
    КонецЕсли;
    Если ЗначениеЗаполнено(ПервыйАдрес.Улица) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Улица);
    КонецЕсли;
    Если ЗначениеЗаполнено(ПервыйАдрес.Дом) Тогда
        ЧастиАдреса.Добавить(ПервыйАдрес.Дом);
    КонецЕсли;
    Конец = СтрЗаменить(СтрСоединить(ЧастиАдреса, ","), " ", "+");
    
    // Формируем промежуточные точки в обратном порядке (от предпоследней до второй)
    ПромежуточныеТочки = "";
    Для Индекс = ДанныеМаршрута.Количество() - 1 По 1 Цикл
        Адрес = ДанныеМаршрута[Индекс];
        ЧастиАдреса = Новый Массив;
        Если ЗначениеЗаполнено(Адрес.Индекс) Тогда
            ЧастиАдреса.Добавить(Адрес.Индекс);
        КонецЕсли;
        Если ЗначениеЗаполнено(Адрес.Страна) Тогда
            ЧастиАдреса.Добавить(Адрес.Страна);
        КонецЕсли;
        Если ЗначениеЗаполнено(Адрес.Регион) Тогда
            ЧастиАдреса.Добавить(Адрес.Регион);
        КонецЕсли;
        Если ЗначениеЗаполнено(Адрес.Город) Тогда
            ЧастиАдреса.Добавить(Адрес.Город);
        КонецЕсли;
        Если ЗначениеЗаполнено(Адрес.Улица) Тогда
            ЧастиАдреса.Добавить(Адрес.Улица);
        КонецЕсли;
        Если ЗначениеЗаполнено(Адрес.Дом) Тогда
            ЧастиАдреса.Добавить(Адрес.Дом);
        КонецЕсли;
        ПромежуточныеТочки = ПромежуточныеТочки + ?(ПромежуточныеТочки = "", "", "|") + 
            СтрЗаменить(СтрСоединить(ЧастиАдреса, ","), " ", "+");
    КонецЦикла;
    
    // Формируем URL
    URL = СтрШаблон("https://maps.google.com/maps?saddr=%1&daddr=%2", Начало, Конец);
    Если ПромежуточныеТочки <> "" Тогда
        URL = URL + "+to:" + ПромежуточныеТочки;
    КонецЕсли;
    
    // Добавляем режим маршрута (автомобиль)
    URL = URL + "&dirflg=d";
    
    Возврат URL;
КонецФункции