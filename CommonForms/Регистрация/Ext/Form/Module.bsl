// Форма регистрации пользователя на сервере, регистрация на локальном устройстве происходит при входе 
// в учетную запись и данные переносятся на мобильное устройство если учетная запись существует и не внесена в локальную 
// базу данных
&НаКлиенте
Процедура Готово(Команда)
	// Проверка логина
	Если ПустаяСтрока(Логин) Тогда
		ПоказатьПредупреждение(, НСтр("ru='Заполните поле с логином!'"));
		Возврат;
	КонецЕсли;
	
	// Проверка пароля
	Если ПустаяСтрока(Пароль) Тогда
		ПоказатьПредупреждение(, НСтр("ru='Заполните поле с паролем!'"));
		Возврат;
	КонецЕсли;
	
	// Проверка длины пароля и наличия букв, цифр и спецсимволов
	Если СтрДлина(Пароль) < 8 Тогда
		ПоказатьПредупреждение(, НСтр("ru='Пароль должен содержать минимум 8 символов!'"));
		Возврат;
	КонецЕсли;
	
	// Проверка наличия букв, цифр и спецсимволов
	ЕстьБуквы = Ложь;
	ЕстьЦифры = Ложь;
	ЕстьСпецсимволы = Ложь;
	Спецсимволы = "!@#$%^&*()_+-=[]{}|;:,.<>?";
	
	Для НомерСимвола = 1 По СтрДлина(Пароль) Цикл
		ТекущийСимвол = Сред(Пароль, НомерСимвола, 1);
		Код = КодСимвола(ТекущийСимвол);
		
		// Проверка на буквы (А-Я, а-я, A-Z, a-z)
		Если (Код >= 1040 И Код <= 1103) // Русские буквы А-Я, а-я
			Или (Код >= 65 И Код <= 90) // Английские буквы A-Z
			Или (Код >= 97 И Код <= 122) Тогда // Английские буквы a-z
			ЕстьБуквы = Истина;
		// Проверка на цифры (0-9)
		ИначеЕсли Код >= 48 И Код <= 57 Тогда
			ЕстьЦифры = Истина;
		// Проверка на спецсимволы
		ИначеЕсли Найти(Спецсимволы, ТекущийСимвол) > 0 Тогда
			ЕстьСпецсимволы = Истина;
		КонецЕсли;
	КонецЦикла;
	
	// Обработчики предупреждений
	Если НЕ ЕстьБуквы Тогда
		ПоказатьПредупреждение(, НСтр("ru='Пароль должен содержать хотя бы одну букву!'"));
		Возврат;
	КонецЕсли;
	
	Если НЕ ЕстьЦифры Тогда
		ПоказатьПредупреждение(, НСтр("ru='Пароль должен содержать хотя бы одну цифру!'"));
		Возврат;
	КонецЕсли;
	
	Если НЕ ЕстьСпецсимволы Тогда
		ПоказатьПредупреждение(, НСтр("ru='Пароль должен содержать хотя бы один специальный символ (!@#$%^&*()_+-=[]{}|;:,.<>?)!'"));
		Возврат;
	КонецЕсли;

	Если ПустаяСтрока(Роль) Тогда
		ПоказатьПредупреждение(, НСтр("ru='Заполните поле с ролью!'"));
		Возврат;
	КонецЕсли;
	
	// Если мобильный значит регистрируем на сервере через соединение, а если центральная база, то записываем в
	// справочник для регистрации администраторов
	Если ОпределитьТипКлиента() Тогда 
		// Регистрация на сервере
		РезультатОТвета = СервисАвторизации.РегистрацияНаСервере(Пароль, Логин, Роль);
	
		// Обработка ответа от сервера
		Если ПустаяСтрока(РезультатОТвета) Тогда
			ПоказатьПредупреждение(, НСтр("ru='Ошибка регистрации, регистрация возможно только при доступе к сети!'"));	
		Иначе
			Сообщить(РезультатОТвета);	
		КонецЕсли;	
	Иначе
		
		//Проверяем роль администратора, ее можно вводить на не мобильном клиенте
		Если ПроверкаНаАдминистратора(Роль) Тогда 
			
			СервисАвторизации.РегистрацияАдминистратора(Пароль, Логин);
			
		Иначе
			
			ПоказатьПредупреждение(, "Выберите роль Администратора!");
			
		КонецЕсли;
		
	КонецЕсли;
	
    // Закрытие текущей формы
	Закрыть();
	
КонецПроцедуры

// Проверка пользователя на роль администратора
&НаСервере
Функция ПроверкаНаАдминистратора(РольПользователя)
	//Проверяем роль администратора, ее можно вводить на не мобильном клиенте
	Если РольПользователя = Перечисления.Роль.Администратор Тогда 
			
		Возврат Истина;
			
	Иначе
			
		Возврат Ложь;
			
	КонецЕсли;
КонецФункции

// Обработчик команды перехода на форму входа в учетную запись
&НаКлиенте
Процедура ВернутьсяВПанельВхода(Команда)
	Закрыть();
КонецПроцедуры

&НаСервере
// Функция определяет, что клиент мобильный
Функция ОпределитьТипКлиента()
    Если ПараметрыСеанса.ЭтоМобильныйКлиент Тогда 
        Возврат Истина; // Мобильный клиент
    Иначе 
        Возврат Ложь;   // Не мобильный
    КонецЕсли;
КонецФункции

&НаКлиенте
// Процедура обработки изменения поля Роль
// Это необходимо, чтобы роль "Администратор" можно было выбирать только в серверной части приложения
Процедура РольПриИзменении()
    Если ОпределитьТипКлиента() Тогда   // Только для мобильного клиента
        // Проверяем, является ли выбранная роль запрещённой
        Если ОпределитьРоль(Роль)  Тогда
            Предупреждение("Выбор роли 'Администратор' запрещён для мобильного клиента!"); // Сообщение пользователю
            Роль = ""; // Очищаем поле
        КонецЕсли;
    КонецЕсли;
КонецПроцедуры

&НаСервере
// Функция проверяет, является ли роль "Администратор"
Функция ОпределитьРоль(РольПользователя)
    Если РольПользователя = Перечисления.Роль.Администратор Тогда
        Возврат Истина; // Запрещённая роль
    Иначе
        Возврат Ложь;   // Допустимая роль
    КонецЕсли;
КонецФункции


